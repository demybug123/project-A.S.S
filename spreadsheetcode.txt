var timeZone = "ICT"; //get yours at https://www.timeanddate.com/time/zones/
var dateTimeFormat = "dd/MM/yyyy HH:mm";

var enableSendingEmails = true;
var emailAddress = "projectass1709@gmail.com"; // comma separate for several emails
// 'bob@example.com';
// 'bob@example.com,admin@example.com';

https://script.google.com/macros/s/AKfycbxibgiGwnmWHVlHq2R7xVx9_wCfG7OEW6YUaLIGtE-Zs3uR5DA/exec

function doGet(e) {
      var result = 'Ok'; // default result
    if (e.parameter == 'undefined') {
        result = 'No Parameters';
    } else {
        var alarm= e.parameter.alarm;
        var date=Utilities.formatDate(new Date(), timeZone, dateTimeFormat);
        if (typeof alarm != 'undefined') {

            sendEmail(stripQuotes(alarm));
            return ContentService.createTextOutput(result);
        }

        var displaySheet= SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Sheet2");
        var sheet= SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Sheet1");
        var bufferSheet= SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Sheet3");
        var lastRow = sheet.getLastRow();
        var newRow = 1;
        if (lastRow > 0) {
            var lastVal = sheet.getRange(lastRow, 1).getValue();
          //if there was no info for (sentEmailIfUnitIsOutForMinutes) checkIfDead() function will append row with 'dead' text
          // so checking do we need to override it
            if (lastVal == 'dead')
                newRow = lastRow; //to overwrite "dead" value
            else
                newRow = lastRow + 1;
        }

        var rowData = [];
        var namesOfParams=[];
        for (var param in parseQuery(e.queryString))
          namesOfParams.push(param);
//      namesOfParams=namesOfParams.reverse();
      
      //creatating headers if first row
        if (newRow == 1) {
            rowData[0] = "Index";
            rowData[1] = "Date";
            var i = 1;
            for (var i=0; i<namesOfParams.length;i++  ) {
                rowData[i+2] = namesOfParams[i];
            }
            var displaySheet= SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Sheet2");
            var header=[["Tên","Nhà sản xuất","Nhập khẩu từ","Loại","Số lượng","Đơn giá"]];
            displaySheet.getRange("E1:J1").setValues(header);
            var newRange = sheet.getRange(newRow, 1, 1, rowData.length);
            newRange.setValues([rowData]);
            var newRange = displaySheet.getRange(newRow, 1, 1, rowData.length);
            newRange.setValues([rowData]);
            rowData = [];
            newRow++;
        }

        rowData[0] = Utilities.formatDate(new Date(), timeZone, dateTimeFormat);
    
        for (var i=0; i<namesOfParams.length;i++  ) {

            var value = stripQuotes(e.parameter[namesOfParams[i]]);

            rowData[i+1] = value;
        }
      var newRange = sheet.getRange(newRow, 2, 1, rowData.length);
      newRange.setValues([rowData]);
      newRange = sheet.getRange(newRow, 3, 1, rowData.length);
      var fromRange = bufferSheet.getRange(newRow, 1, 1, 5);
      var displayRow=newRow;
      if(displayRow!=2)
      displayRow=newRow+2*(newRow-2);
      var toRange = displaySheet.getRange(displayRow, 3, 5, 1);
      newRange.copyTo(fromRange, SpreadsheetApp.CopyPasteType.PASTE_VALUES);
      var serial=bufferSheet.getRange(newRow, 2).getValue();
      bufferSheet.getRange(newRow,7).setValue(serial);
      bufferSheet.getRange(newRow, 1).splitTextToColumns('a');
      bufferSheet.getRange(newRow, 7).splitTextToColumns('a');
      fromRange.copyTo(toRange, SpreadsheetApp.CopyPasteType.PASTE_NORMAL, true);
      fromRange=bufferSheet.getRange(newRow, 7, 1, 5);
      toRange = displaySheet.getRange(displayRow, 4, 5, 1);
      fromRange.copyTo(toRange, SpreadsheetApp.CopyPasteType.PASTE_NORMAL, true);
      displaySheet.getRange( displayRow,2,3).setValue(Utilities.formatDate(new Date(), timeZone, dateTimeFormat));
      var n=3;
      for(var i=displayRow;i<displayRow+3;i++){
      var ID = displaySheet.getRange(i, 1);
      ID.setValue(i-1);
      
      displaySheet.getRange(2, 5).setFormula("=LEFT(D2;5)");
      var fillDownRange=displaySheet.getRange(displayRow, 5, 3);
      displaySheet.getRange(2, 5).copyTo(fillDownRange);
      displaySheet.getRange(2, 6).setFormula('=DGET(Sheet4!$A$1:$F$4;"Manufacturer";{"Serial1";MID(D2;6;2)})');
      var fillDownRange=displaySheet.getRange(displayRow, 6, 3);
      displaySheet.getRange(2, 6).copyTo(fillDownRange);
      displaySheet.getRange(2, 7).setFormula('=DGET(Sheet4!$A$1:$F$4;"Imported from";{"Serial2";MID(D2;8;2)})');
      var fillDownRange=displaySheet.getRange(displayRow, 7, 3);
      displaySheet.getRange(2, 7).copyTo(fillDownRange);
      displaySheet.getRange(2, 8).setFormula('=DGET(Sheet4!$A$1:$F$4;"Type";{"Serial3";MID(D2;10;1)})');
      var fillDownRange=displaySheet.getRange(displayRow, 8, 3);
      displaySheet.getRange(2, 8).copyTo(fillDownRange);      
      displaySheet.getRange(2, 9).setFormula("=MID(D2;11;1)");
      var fillDownRange=displaySheet.getRange(displayRow, 9, 3);
      displaySheet.getRange(2, 9).copyTo(fillDownRange);
      displaySheet.getRange(2, 10).setFormula("=RIGHT(D2;2)");
      var fillDownRange=displaySheet.getRange(displayRow, 10, 3);
      displaySheet.getRange(2, 10).copyTo(fillDownRange);
      
      
    }}
    // Return result of operation
    return ContentService.createTextOutput(result);
}

function test(){
        var displaySheet= SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Sheet2");
            var header=[["Name","Manufacturer","Imported from","Type","Amount","Price"]];
            displaySheet.getRange("E1:J1").setValues(header);
}

/**
 * Remove leading and trailing single or double quotes
 */
function stripQuotes(value) {
    return value.replace(/^["']|['"]$/g, "");
}

function parseQuery(queryString) {
    var query = {};
    var pairs = (queryString[0] === '?' ? queryString.substr(1) : queryString).split('&');
    for (var i = 0; i < pairs.length; i++) {
        var pair = pairs[i].split('=');
        query[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1] || '');
    }
    return query;
}

function sendEmail(message) {

   if (!enableSendingEmails)
        return;
    var subject = '!!!CẢNH BÁO!!!';
   MailApp.sendEmail(emailAddress, subject, message);
}
